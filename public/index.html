<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Scene Detector</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-glass: rgba(22, 33, 62, 0.8);
      --accent-cyan: #00d9ff;
      --accent-lime: #00ff88;
      --accent-red: #ff6b6b;
      --text-primary: #ffffff;
      --text-secondary: #a0a0a0;
      --border-color: rgba(255, 255, 255, 0.1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      min-height: 100vh;
      color: var(--text-primary);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      text-align: center;
      padding: 30px 0;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 30px;
    }

    header h1 {
      font-size: 2.5rem;
      background: linear-gradient(90deg, var(--accent-cyan), var(--accent-lime));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    header p {
      color: var(--text-secondary);
      margin-top: 10px;
    }

    /* Upload Section */
    .upload-section {
      background: var(--bg-glass);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 30px;
      border: 1px solid var(--border-color);
      margin-bottom: 30px;
    }

    .upload-zone {
      border: 2px dashed var(--accent-cyan);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .upload-zone:hover, .upload-zone.dragover {
      background: rgba(0, 217, 255, 0.1);
      border-color: var(--accent-lime);
    }

    .upload-zone input {
      display: none;
    }

    .upload-zone .icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .upload-zone p {
      color: var(--text-secondary);
    }

    .upload-options {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group label {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    select, input[type="number"] {
      padding: 10px 15px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 1rem;
    }

    select:focus, input:focus {
      outline: none;
      border-color: var(--accent-cyan);
    }

    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-cyan), #0099cc);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 217, 255, 0.4);
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--border-color);
    }

    /* Progress Bar */
    .progress-container {
      display: none;
      margin-top: 20px;
    }

    .progress-container.active {
      display: block;
    }

    .progress-bar {
      height: 8px;
      background: var(--bg-primary);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-cyan), var(--accent-lime));
      width: 0%;
      transition: width 0.3s ease;
    }

    .progress-text {
      text-align: center;
      margin-top: 10px;
      color: var(--text-secondary);
    }

    /* Main Content Grid */
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 30px;
    }

    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Video Player Section */
    .video-section {
      background: var(--bg-glass);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid var(--border-color);
    }

    .video-container {
      position: relative;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
    }

    video {
      width: 100%;
      display: block;
    }

    .video-placeholder {
      aspect-ratio: 16/9;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
    }

    /* Timeline with Scene Markers */
    .timeline-container {
      margin-top: 15px;
      padding: 10px;
      background: var(--bg-primary);
      border-radius: 8px;
    }

    .timeline {
      position: relative;
      height: 40px;
      background: var(--bg-secondary);
      border-radius: 4px;
      overflow: hidden;
    }

    .timeline-progress {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      background: linear-gradient(90deg, var(--accent-cyan), var(--accent-lime));
      width: 0%;
      transition: width 0.1s linear;
    }

    .scene-marker {
      position: absolute;
      top: 0;
      width: 3px;
      height: 100%;
      background: var(--accent-red);
      cursor: pointer;
      transition: transform 0.2s;
    }

    .scene-marker:hover {
      transform: scaleX(2);
      z-index: 10;
    }

    .scene-marker::after {
      content: attr(data-scene);
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-secondary);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      opacity: 0;
      transition: opacity 0.2s;
      white-space: nowrap;
    }

    .scene-marker:hover::after {
      opacity: 1;
    }

    /* Video Info */
    .video-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin-top: 15px;
      padding: 15px;
      background: var(--bg-primary);
      border-radius: 8px;
    }

    .info-item {
      text-align: center;
    }

    .info-item .value {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--accent-cyan);
    }

    .info-item .label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    /* Sidebar */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .panel {
      background: var(--bg-glass);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid var(--border-color);
    }

    .panel h3 {
      margin-bottom: 15px;
      font-size: 1.1rem;
      color: var(--accent-cyan);
    }

    /* Scene Detection Controls */
    .slider-container {
      margin-bottom: 15px;
    }

    .slider-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .slider-hint {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--bg-primary);
      outline: none;
      -webkit-appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent-cyan);
      cursor: pointer;
    }

    /* Scene List */
    .scene-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .scene-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-primary);
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .scene-item:hover {
      background: rgba(0, 217, 255, 0.1);
    }

    .scene-item.selected {
      border-color: var(--accent-cyan);
      background: rgba(0, 217, 255, 0.15);
    }

    .scene-thumb {
      width: 60px;
      height: 40px;
      background: var(--bg-secondary);
      border-radius: 4px;
      object-fit: cover;
      flex-shrink: 0;
    }

    .scene-info {
      flex: 1;
      min-width: 0;
    }

    .scene-number {
      font-weight: bold;
      color: var(--accent-cyan);
    }

    .scene-time {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    /* Extraction Panel */
    .extraction-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .preview-thumbs {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .preview-thumb {
      flex: 1;
      text-align: center;
    }

    .preview-thumb img {
      width: 100%;
      border-radius: 8px;
      background: var(--bg-primary);
    }

    .preview-thumb .label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 5px;
    }

    .download-link {
      display: none;
      padding: 15px;
      background: rgba(0, 255, 136, 0.1);
      border: 1px solid var(--accent-lime);
      border-radius: 8px;
      text-align: center;
    }

    .download-link.active {
      display: block;
    }

    .download-link a {
      color: var(--accent-lime);
      text-decoration: none;
      font-weight: bold;
    }

    /* Hidden state */
    .hidden {
      display: none !important;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--bg-secondary);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent-cyan);
    }

    /* Error message */
    .error-message {
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid var(--accent-red);
      color: var(--accent-red);
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }

    /* Success message */
    .success-message {
      background: rgba(0, 255, 136, 0.1);
      border: 1px solid var(--accent-lime);
      color: var(--accent-lime);
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üé¨ Video Scene Detector</h1>
      <p>Upload videos, detect scene boundaries, and extract segments automatically</p>
    </header>

    <!-- Upload Section -->
    <section class="upload-section">
      <div class="upload-zone" id="uploadZone">
        <input type="file" id="fileInput" accept=".mp4,.avi,.mov,.mkv,.webm">
        <div class="icon">üìÅ</div>
        <p>Drag & drop a video file here, or click to browse</p>
        <p style="font-size: 0.85rem; margin-top: 10px;">Supported: MP4, AVI, MOV, MKV, WebM (max 500MB)</p>
      </div>
      
      <div class="upload-options">
        <div class="form-group">
          <label>Target FPS</label>
          <select id="targetFps">
            <option value="24" selected>24 FPS (Cinema)</option>
            <option value="30">30 FPS (Standard)</option>
            <option value="25">25 FPS (PAL)</option>
            <option value="16">16 FPS (Vintage)</option>
          </select>
        </div>
        <button class="btn btn-primary" id="uploadBtn" disabled>
          <span>‚¨ÜÔ∏è</span> Upload & Process
        </button>
      </div>
      
      <div class="progress-container" id="progressContainer">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">Uploading...</div>
      </div>
      
      <div id="messageContainer"></div>
    </section>

    <!-- Main Content -->
    <div class="main-grid" id="mainContent" style="display: none;">
      <!-- Video Player Section -->
      <div class="video-section">
        <div class="video-container">
          <video id="videoPlayer" controls>
            Your browser does not support the video tag.
          </video>
          <div class="video-placeholder" id="videoPlaceholder" style="display: none;">
            <p>Upload a video to get started</p>
          </div>
        </div>
        
        <div class="timeline-container">
          <div class="timeline" id="timeline">
            <div class="timeline-progress" id="timelineProgress"></div>
          </div>
        </div>
        
        <div class="video-info" id="videoInfo">
          <div class="info-item">
            <div class="value" id="infoDuration">-</div>
            <div class="label">Duration</div>
          </div>
          <div class="info-item">
            <div class="value" id="infoFps">-</div>
            <div class="label">FPS</div>
          </div>
          <div class="info-item">
            <div class="value" id="infoResolution">-</div>
            <div class="label">Resolution</div>
          </div>
          <div class="info-item">
            <div class="value" id="infoFrames">-</div>
            <div class="label">Total Frames</div>
          </div>
          <div class="info-item">
            <div class="value" id="infoScenes">-</div>
            <div class="label">Scenes</div>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Scene Detection Controls -->
        <div class="panel">
          <h3>üîç Scene Detection</h3>
          
          <!-- Min Scene Length Slider -->
          <div class="slider-container">
            <div class="slider-label">
              <span>Min Scene Length</span>
              <span id="minSceneValue">1.2s</span>
            </div>
            <input type="range" id="minSceneLength" min="0.1" max="10" value="1.2" step="0.1">
            <div class="slider-hint">Minimum time between scene changes</div>
          </div>
          
          <!-- Threshold Slider -->
          <div class="slider-container">
            <div class="slider-label">
              <span>Sensitivity (Threshold)</span>
              <span id="thresholdValue">30</span>
            </div>
            <input type="range" id="threshold" min="5" max="50" value="30" step="1">
            <div class="slider-hint">Lower = more sensitive (more scenes)</div>
          </div>
          
          <button class="btn btn-secondary" id="reDetectBtn" style="width: 100%;">
            üîÑ Re-detect Scenes
          </button>
        </div>

        <!-- Scene List -->
        <div class="panel">
          <h3>üìã Scenes</h3>
          <div class="scene-list" id="sceneList">
            <!-- Scene items will be populated here -->
          </div>
        </div>

        <!-- Extraction Panel -->
        <div class="panel">
          <h3>‚úÇÔ∏è Extract Scene</h3>
          <div class="extraction-form">
            <div class="form-group">
              <label>Selected Scene</label>
              <input type="text" id="selectedScene" readonly placeholder="Select a scene">
            </div>
            
            <div class="form-group">
              <label>Start Offset (frames, can be negative)</label>
              <input type="number" id="startOffset" value="0">
            </div>
            
            <div class="form-group">
              <label>Extract Length (frames, max 1000)</label>
              <input type="number" id="extractFrames" placeholder="Leave empty for full scene">
            </div>
            
            <div class="preview-thumbs" id="previewThumbs">
              <div class="preview-thumb">
                <img id="previewStart" src="" alt="Start frame">
                <div class="label">Start</div>
              </div>
              <div class="preview-thumb">
                <img id="previewEnd" src="" alt="End frame">
                <div class="label">End</div>
              </div>
            </div>
            
            <button class="btn btn-primary" id="extractBtn" disabled>
              ‚ö° Extract Scene
            </button>
            
            <div class="download-link" id="downloadLink">
              <a href="#" id="downloadAnchor" download>‚¨áÔ∏è Download Extracted Scene</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // State
    let currentVideo = null;
    let currentScenes = [];
    let selectedScene = null;
    let uploadedFile = null;

    // DOM Elements
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const targetFps = document.getElementById('targetFps');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const messageContainer = document.getElementById('messageContainer');
    const mainContent = document.getElementById('mainContent');
    const videoPlayer = document.getElementById('videoPlayer');
    const videoPlaceholder = document.getElementById('videoPlaceholder');
    const timeline = document.getElementById('timeline');
    const timelineProgress = document.getElementById('timelineProgress');
    const sceneList = document.getElementById('sceneList');
    const minSceneLength = document.getElementById('minSceneLength');
    const minSceneValue = document.getElementById('minSceneValue');
    const threshold = document.getElementById('threshold');
    const thresholdValue = document.getElementById('thresholdValue');
    const reDetectBtn = document.getElementById('reDetectBtn');
    const selectedSceneInput = document.getElementById('selectedScene');
    const startOffset = document.getElementById('startOffset');
    const extractFrames = document.getElementById('extractFrames');
    const extractBtn = document.getElementById('extractBtn');
    const downloadLink = document.getElementById('downloadLink');
    const downloadAnchor = document.getElementById('downloadAnchor');
    const previewStart = document.getElementById('previewStart');
    const previewEnd = document.getElementById('previewEnd');

    // Event Listeners
    uploadZone.addEventListener('click', () => fileInput.click());
    
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });
    
    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });
    
    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFileSelect(files[0]);
      }
    });
    
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
      }
    });
    
    uploadBtn.addEventListener('click', uploadVideo);
    
    minSceneLength.addEventListener('input', (e) => {
      minSceneValue.textContent = e.target.value + 's';
    });
    
    threshold.addEventListener('input', (e) => {
      thresholdValue.textContent = e.target.value;
    });
    
    startOffset.addEventListener('input', () => {
      if (selectedScene) loadPreviewThumbnails();
    });
    
    extractFrames.addEventListener('input', () => {
      if (selectedScene) loadPreviewThumbnails();
    });
    
    reDetectBtn.addEventListener('click', reDetectScenes);
    
    extractBtn.addEventListener('click', extractScene);
    
    videoPlayer.addEventListener('timeupdate', updateTimeline);
    
    videoPlayer.addEventListener('loadedmetadata', () => {
      videoPlaceholder.style.display = 'none';
      videoPlayer.style.display = 'block';
    });

    // Functions
    function handleFileSelect(file) {
      const validExtensions = ['mp4', 'avi', 'mov', 'mkv', 'webm'];
      const ext = file.name.split('.').pop().toLowerCase();
      
      if (!validExtensions.includes(ext)) {
        showMessage('Invalid file type. Supported: MP4, AVI, MOV, MKV, WebM', 'error');
        return;
      }
      
      if (file.size > 524288000) {
        showMessage('File too large. Maximum size is 500MB', 'error');
        return;
      }
      
      uploadedFile = file;
      uploadBtn.disabled = false;
      showMessage(`Selected: ${file.name} (${formatFileSize(file.size)})`, 'success');
    }

    async function uploadVideo() {
      if (!uploadedFile) return;
      
      const formData = new FormData();
      formData.append('file', uploadedFile);
      formData.append('target_fps', targetFps.value);
      
      progressContainer.classList.add('active');
      uploadBtn.disabled = true;
      progressFill.style.width = '0%';
      progressText.textContent = 'Uploading...';
      
      try {
        // Simulate progress
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += Math.random() * 5;
          if (progress > 90) progress = 90;
          progressFill.style.width = progress + '%';
        }, 500);
        
        const response = await fetch('/upload', {
          method: 'POST',
          body: formData
        });
        
        clearInterval(progressInterval);
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Upload failed');
        }
        
        const data = await response.json();
        
        progressFill.style.width = '100%';
        progressText.textContent = 'Complete!';
        
        setTimeout(() => {
          progressContainer.classList.remove('active');
        }, 1000);
        
        loadVideo(data);
        showMessage('Video uploaded and processed successfully!', 'success');
        
      } catch (err) {
        showMessage(err.message, 'error');
        uploadBtn.disabled = false;
        progressContainer.classList.remove('active');
      }
    }

    function loadVideo(data) {
      currentVideo = data;
      currentScenes = data.scenes;
      
      // Update video player
      videoPlayer.src = `/video/${data.filename}`;
      videoPlayer.load();
      
      // Show main content
      mainContent.style.display = 'grid';
      
      // Update video info
      document.getElementById('infoDuration').textContent = formatTime(data.video_info.duration);
      document.getElementById('infoFps').textContent = data.video_info.fps.toFixed(1);
      document.getElementById('infoResolution').textContent = `${data.video_info.width}x${data.video_info.height}`;
      document.getElementById('infoFrames').textContent = data.video_info.total_frames.toLocaleString();
      document.getElementById('infoScenes').textContent = data.scenes.length;
      
      // Render scenes
      renderScenes();
      renderTimelineMarkers();
      
      // Scroll to main content
      mainContent.scrollIntoView({ behavior: 'smooth' });
    }

    async function renderScenes() {
      sceneList.innerHTML = '';
      
      currentScenes.forEach((scene, index) => {
        const sceneEl = document.createElement('div');
        sceneEl.className = 'scene-item';
        sceneEl.dataset.index = index;
        sceneEl.innerHTML = `
          <img class="scene-thumb" id="scene-thumb-${index}" src="" alt="Scene ${scene.scene_number}" style="background: var(--bg-secondary);">
          <div class="scene-info">
            <div class="scene-number">Scene ${scene.scene_number}</div>
            <div class="scene-time">${formatTime(scene.start_time)} - ${formatTime(scene.end_time)}</div>
            <div class="scene-time">(${scene.end_frame - scene.start_frame + 1} frames)</div>
          </div>
        `;
        
        sceneEl.addEventListener('click', () => selectScene(index));
        sceneList.appendChild(sceneEl);
        
        // Load thumbnail for this scene
        loadSceneThumbnail(index, scene.start_time);
      });
    }
    
    async function loadSceneThumbnail(index, timestamp) {
      if (!currentVideo) return;
      
      try {
        const response = await fetch(`/preview?filepath=${encodeURIComponent(currentVideo.filepath)}&timestamp=${timestamp}`);
        if (response.ok) {
          const data = await response.json();
          const thumbImg = document.getElementById(`scene-thumb-${index}`);
          if (thumbImg) {
            thumbImg.src = data.preview_url;
          }
        }
      } catch (err) {
        console.error(`Failed to load thumbnail for scene ${index}:`, err);
      }
    }

    function renderTimelineMarkers() {
      // Clear existing markers
      timeline.querySelectorAll('.scene-marker').forEach(m => m.remove());
      
      if (!currentVideo) return;
      
      const duration = currentVideo.video_info.duration;
      
      currentScenes.forEach((scene, index) => {
        const marker = document.createElement('div');
        marker.className = 'scene-marker';
        marker.style.left = (scene.start_time / duration * 100) + '%';
        marker.dataset.scene = `Scene ${index + 1}`;
        marker.title = `Scene ${index + 1}: ${formatTime(scene.start_time)}`;
        marker.addEventListener('click', (e) => {
          e.stopPropagation();
          selectScene(index);
          videoPlayer.currentTime = scene.start_time;
        });
        timeline.appendChild(marker);
      });
    }

    function selectScene(index) {
      // Remove previous selection
      document.querySelectorAll('.scene-item').forEach(el => el.classList.remove('selected'));
      
      // Add selection to new element
      const sceneEl = sceneList.children[index];
      if (sceneEl) {
        sceneEl.classList.add('selected');
        sceneEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
      
      selectedScene = currentScenes[index];
      selectedSceneInput.value = `Scene ${selectedScene.scene_number} (${formatTime(selectedScene.start_time)} - ${formatTime(selectedScene.end_time)})`;
      extractBtn.disabled = false;
      
      // Update preview thumbnails
      loadPreviewThumbnails();
      
      // Seek video to scene start
      videoPlayer.currentTime = selectedScene.start_time;
    }

    async function loadPreviewThumbnails() {
      if (!selectedScene || !currentVideo) return;
      
      const fps = currentVideo.video_info.fps;
      const offset = parseInt(startOffset.value) || 0;
      const extractCount = parseInt(extractFrames.value) || 0;
      
      // Calculate start frame (scene start + offset)
      const startFrame = selectedScene.start_frame + offset;
      const startTime = startFrame / fps;
      
      // Calculate end frame (start frame + extract count, or scene end if not specified)
      let endFrame;
      if (extractCount > 0) {
        endFrame = startFrame + extractCount;
      } else {
        endFrame = selectedScene.end_frame;
      }
      // Clamp end frame to scene bounds
      endFrame = Math.min(endFrame, selectedScene.end_frame);
      const endTime = endFrame / fps;
      
      try {
        // Load start frame preview
        const startResponse = await fetch(`/preview?filepath=${encodeURIComponent(currentVideo.filepath)}&timestamp=${startTime}`);
        if (startResponse.ok) {
          const startData = await startResponse.json();
          previewStart.src = startData.preview_url;
        }
        
        // Load end frame preview
        const endResponse = await fetch(`/preview?filepath=${encodeURIComponent(currentVideo.filepath)}&timestamp=${endTime}`);
        if (endResponse.ok) {
          const endData = await endResponse.json();
          previewEnd.src = endData.preview_url;
        }
      } catch (err) {
        console.error('Preview loading error:', err);
      }
    }

    async function reDetectScenes() {
      if (!currentVideo) return;
      
      reDetectBtn.disabled = true;
      reDetectBtn.textContent = 'üîÑ Detecting...';
      
      try {
        const response = await fetch('/detect-scenes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            filepath: currentVideo.filepath,
            min_scene_length: parseFloat(minSceneLength.value),
            threshold: parseInt(threshold.value)
          })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Scene detection failed');
        }
        
        const data = await response.json();
        currentScenes = data.scenes;
        
        // Update UI
        document.getElementById('infoScenes').textContent = data.scenes.length;
        renderScenes();
        renderTimelineMarkers();
        
        showMessage(`Detected ${data.scenes.length} scenes`, 'success');
        
      } catch (err) {
        showMessage(err.message, 'error');
      } finally {
        reDetectBtn.disabled = false;
        reDetectBtn.textContent = 'üîÑ Re-detect Scenes';
      }
    }

    async function extractScene() {
      if (!selectedScene || !currentVideo) return;
      
      extractBtn.disabled = true;
      extractBtn.textContent = '‚è≥ Extracting...';
      downloadLink.classList.remove('active');
      
      try {
        const response = await fetch('/extract', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            filepath: currentVideo.filepath,
            start_frame: selectedScene.start_frame,
            end_frame: selectedScene.end_frame,
            fps: currentVideo.video_info.fps,
            start_offset: parseInt(startOffset.value) || 0,
            extract_frames: parseInt(extractFrames.value) || null
          })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Extraction failed');
        }
        
        const data = await response.json();
        
        downloadAnchor.href = data.download_url;
        downloadAnchor.download = data.filename;
        downloadLink.classList.add('active');
        
        showMessage(`Scene extracted successfully! Duration: ${formatTime(data.duration)}`, 'success');
        
      } catch (err) {
        showMessage(err.message, 'error');
      } finally {
        extractBtn.disabled = false;
        extractBtn.textContent = '‚ö° Extract Scene';
      }
    }

    function updateTimeline() {
      if (videoPlayer.duration) {
        const progress = (videoPlayer.currentTime / videoPlayer.duration) * 100;
        timelineProgress.style.width = progress + '%';
      }
    }

    function showMessage(message, type) {
      messageContainer.innerHTML = `<div class="${type}-message">${message}</div>`;
      setTimeout(() => {
        messageContainer.innerHTML = '';
      }, 5000);
    }

    function formatTime(seconds) {
      if (!seconds || isNaN(seconds)) return '-';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      const ms = Math.floor((seconds % 1) * 100);
      return `${mins}:${secs.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0')}`;
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
  </script>
</body>
</html>